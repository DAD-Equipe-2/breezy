services:
  
  gateway:
    image: nginx:alpine
    container_name: breezy-api-gateway
    ports:
      - "8080:8080"
    volumes:
      - ./backend/gateway/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - app-network
    depends_on:
      - auth-service

  auth-service:
    build:
      context: ./backend/auth
      dockerfile: Dockerfile.dev    # Use Dockerfile.dev for development, Dockerfile for production
    container_name: breezy-auth-service
    environment:
      - DB_CONNECTION=mongodb://auth-mongo:27017/auth
    volumes:
      - ./backend/auth:/app         # Mount local source code into container (remove for production)
      - /app/node_modules           # Prevent overwriting node_modules from host (remove for production)
    networks:
      - app-network
    depends_on:
      - auth-mongo

  auth-mongo:
    image: mongo:latest
    container_name: breezy-auth-mongo
    volumes:
      - auth-mongo-data:/data/db

  user-service:
    build:
      context: ./backend/user
      dockerfile: Dockerfile.dev
    container_name: breezy-user-service
    environment:
      - DB_CONNECTION=mongodb://user-mongo:27017/user
    volumes:
      - ./backend/user:/app
      - /app/node_modules
    networks:
      - app-network
    depends_on:
      - user-mongo

  user-mongo:
    image: mongo:latest
    container_name: breezy-user-mongo
    volumes:
      - user-mongo-data:/data/db
    networks:
      - app-network

  profile-service:
    build:
      context: ./backend/profile
      dockerfile: Dockerfile.dev
    container_name: breezy-profile-service
    environment:
      - DB_CONNECTION=mongodb://profile-mongo:27017/profile
    volumes:
      - ./backend/profile:/app
      # - /app/node_modules            # commenter pour éviter d’écraser node_modules
    networks:
      - app-network
    depends_on:
      - profile-mongo

  profile-mongo:
    image: mongo:latest
    container_name: breezy-profile-mongo
    volumes:
      - profile-mongo-data:/data/db
    networks:
      - app-network

  post-service:
    build:
      context: ./backend/post
      dockerfile: Dockerfile.dev
    container_name: breezy-post-service
    environment:
      - DB_CONNECTION=mongodb://post-mongo:27017/post
    volumes:
      - ./backend/post:/app
      # - /app/node_modules
    networks:
      - app-network
    depends_on:
      - post-mongo

  post-mongo:
    image: mongo:latest
    container_name: breezy-post-mongo
    volumes:
      - post-mongo-data:/data/db
    networks:
      - app-network


  message-service:
    build:
      context: ./backend/message
      dockerfile: Dockerfile.dev
    container_name: breezy-message-service
    environment:
      - DB_CONNECTION=mongodb://message-mongo:27017/message
    volumes:
      - ./backend/message:/app
    networks:
      - app-network
    depends_on:
      - message-mongo

  message-mongo:
    image: mongo:latest
    container_name: breezy-message-mongo
    volumes:
      - message-mongo-data:/data/db
    networks:
      - app-network

volumes:
  auth-mongo-data:
  user-mongo-data:
  profile-mongo-data:
  post-mongo-data:
  message-mongo-data:

networks:
  app-network:
    driver: bridge
